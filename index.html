<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Personal Finance Premium</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2pdf.js"></script>

<style>
*{box-sizing:border-box}
body{
  margin:0;padding:16px;
  font-family:system-ui,sans-serif;
  background:#f1f5f9;color:#0f172a
}
.container{max-width:1100px;margin:auto}
.card{
  background:#fff;border-radius:14px;
  padding:14px;margin-bottom:14px;
  box-shadow:0 6px 18px rgba(0,0,0,.08)
}
h1{margin:6px 0}
h2{margin:0 0 8px;font-size:18px}
input,button,select{
  padding:10px;border-radius:8px;
  border:1px solid #cbd5e1;width:100%
}
button{background:#2563eb;color:#fff;border:none;cursor:pointer}
button.red{background:#dc2626}
button.gray{background:#334155}

.grid{display:grid;gap:12px}
.grid-2{grid-template-columns:1fr}
@media(min-width:768px){.grid-2{grid-template-columns:1fr 1fr}}

.progress{background:#e5e7eb;height:12px;border-radius:10px;overflow:hidden}
.bar{height:100%;transition:.3s}
.safe{background:#22c55e}
.warn{background:#f59e0b}
.danger{background:#ef4444}

table{width:100%;border-collapse:collapse;font-size:14px}
th,td{padding:8px;border-bottom:1px solid #e5e7eb}
th{background:#f8fafc;text-align:left}

.blur span.amount{filter:blur(6px)}
.small{font-size:13px;color:#475569}
</style>
</head>

<body>

<div id="app" class="container">

<h1>ğŸ“Š Personal Finance Premium</h1>
<div class="grid grid-2">
  <button class="gray" onclick="toggleBlur()">ğŸ‘ Mode Privat</button>
  <button class="red" onclick="resetData()">ğŸ—‘ Reset Data</button>
</div>

<div class="card">
  <h2>ğŸ“… Bulan</h2>
  <input type="month" id="bulan" onchange="render()">
</div>

<div class="card">
  <h2>ğŸ“Œ Ringkasan</h2>
  <p>Pemasukan: Rp <span class="amount" id="sumIn">0</span></p>
  <p>Pengeluaran: Rp <span class="amount" id="sumOut">0</span></p>
  <p><b>Saldo: Rp <span class="amount" id="saldo">0</span></b></p>
</div>

<!-- BUDGET PER KATEGORI -->
<div class="card">
  <h2>ğŸ¯ Budget per Kategori</h2>
  <div class="grid grid-2">
    <input id="bKat" placeholder="Kategori (Makan, Transport)">
    <input id="bNom" placeholder="Target (Rp)">
  </div>
  <button onclick="saveCategoryBudget()">Simpan Budget</button>

  <div id="budgetList"></div>
</div>

<!-- INPUT -->
<div class="grid grid-2">
  <div class="card">
    <h2>â• Pemasukan</h2>
    <input type="date" id="inTgl">
    <input id="inSrc" placeholder="Sumber">
    <input id="inNom" placeholder="Nominal (Rp)">
    <button onclick="addIncome()">Simpan</button>
  </div>

  <div class="card">
    <h2>â– Pengeluaran</h2>
    <input type="date" id="outTgl">
    <input id="outKat" placeholder="Kategori">
    <input id="outNom" placeholder="Nominal (Rp)">
    <button onclick="addOut()">Simpan</button>
  </div>
</div>

<div class="card">
  <h2>ğŸ“ˆ Grafik Pengeluaran</h2>
  <canvas id="chart"></canvas>
</div>

<div class="card">
  <h2>ğŸ“‘ Riwayat</h2>
  <table>
    <thead>
      <tr><th>Tanggal</th><th>Keterangan</th><th>Nominal</th><th></th></tr>
    </thead>
    <tbody id="list"></tbody>
  </table>
</div>

<button onclick="printPDF()">ğŸ–¨ Cetak PDF</button>
<button onclick="exportExcel()" style="margin-top:10px;background:#16a34a">
  ğŸ“Š Export Excel
</button>


</div>

<script>
let db = JSON.parse(localStorage.getItem("pf2")) || {
  income:[],
  out:[],
  budget:{}
};

let chart, blur=false;

const f=v=>v.replace(/\D/g,'').replace(/\B(?=(\d{3})+(?!\d))/g,'.');
const p=v=>Number(v.replace(/\./g,''));

bNom.oninput=e=>e.target.value=f(e.target.value);
inNom.oninput=e=>e.target.value=f(e.target.value);
outNom.oninput=e=>e.target.value=f(e.target.value);

function save(){localStorage.setItem("pf2",JSON.stringify(db));render()}
function m(){return bulan.value}
function byMonth(a){return !m()?a:a.filter(x=>x.t.startsWith(m()))}

function saveCategoryBudget(){
  if(!m())return alert("Pilih bulan");
  if(!bKat.value||!bNom.value)return alert("Lengkapi");
  db.budget[m()] ??= {};
  db.budget[m()][bKat.value]=p(bNom.value);
  bKat.value="";bNom.value="";
  save();
}

function addIncome(){
  if(!inTgl.value||!inSrc.value||!inNom.value)return;
  db.income.push({id:Date.now(),t:inTgl.value,k:inSrc.value,n:p(inNom.value)});
  inNom.value=""; save();
}

function addOut(){
  if(!outTgl.value||!outKat.value||!outNom.value)return;
  db.out.push({id:Date.now(),t:outTgl.value,k:outKat.value,n:p(outNom.value)});
  outNom.value=""; save();
}

function del(id){
  db.income=db.income.filter(x=>x.id!==id);
  db.out=db.out.filter(x=>x.id!==id);
  save();
}

function resetData(){
  if(confirm("Hapus semua data?")){
    localStorage.removeItem("pf2");
    location.reload();
  }
}

function toggleBlur(){
  blur=!blur; app.classList.toggle("blur",blur);
}

function render(){
  let inc=byMonth(db.income);
  let out=byMonth(db.out);

  let ti=inc.reduce((a,b)=>a+b.n,0);
  let to=out.reduce((a,b)=>a+b.n,0);

  sumIn.innerText=ti.toLocaleString("id-ID");
  sumOut.innerText=to.toLocaleString("id-ID");
  saldo.innerText=(ti-to).toLocaleString("id-ID");

  renderBudget(out);
  renderChart(out);
  renderTable(inc,out);
}

function renderBudget(out){
  let b=db.budget[m()]||{};
  let html="";
  for(let k in b){
    let used=out.filter(x=>x.k===k).reduce((a,b)=>a+b.n,0);
    let pct=Math.min(used/b[k]*100,100);
    let cls=pct<80?"safe":pct<100?"warn":"danger";
    html+=`
      <div class="small">${k} â€” Rp ${used.toLocaleString()} / ${b[k].toLocaleString()}</div>
      <div class="progress"><div class="bar ${cls}" style="width:${pct}%"></div></div>
    `;
  }
  budgetList.innerHTML=html||"<i class='small'>Belum ada budget kategori</i>";
}

function renderChart(o){
  let m={}; o.forEach(x=>m[x.k]=(m[x.k]||0)+x.n);
  if(chart)chart.destroy();
  chart=new Chart(chartEl,{
    type:"pie",
    data:{labels:Object.keys(m),datasets:[{data:Object.values(m)}]}
  });
}

function renderTable(inc,out){
  let r=[];
  inc.forEach(x=>r.push({...x,n:x.n}));
  out.forEach(x=>r.push({...x,n:-x.n}));
  r.sort((a,b)=>a.t.localeCompare(b.t));
  list.innerHTML=r.map(x=>`
    <tr>
      <td>${x.t}</td>
      <td>${x.k}</td>
      <td style="color:${x.n<0?'red':'green'}">
        Rp <span class="amount">${Math.abs(x.n).toLocaleString()}</span>
      </td>
      <td><button class="red" onclick="del(${x.id})">ğŸ—‘</button></td>
    </tr>
  `).join("");
}

function printPDF(){
  const el = document.getElementById("app");

  // Tunggu chart selesai render
  setTimeout(() => {
    html2pdf(el, {
      margin: 10,
      filename: "Personal-Finance.pdf",
      image: { type: "jpeg", quality: 0.98 },
      html2canvas: {
        scale: 2,
        useCORS: true,
        scrollY: 0
      },
      jsPDF: {
        unit: "mm",
        format: "a4",
        orientation: "portrait"
      }
    });
  }, 600); // delay WAJIB
}

function exportExcel(){
  const inc = byMonth(db.income);
  const out = byMonth(db.out);

  let rows = [];
  rows.push(["Tanggal","Jenis","Kategori / Sumber","Nominal"]);

  inc.forEach(x=>{
    rows.push([x.t,"Pemasukan",x.k,x.n]);
  });

  out.forEach(x=>{
    rows.push([x.t,"Pengeluaran",x.k,-x.n]);
  });

  let csv = rows.map(r=>r.join(",")).join("\n");

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = `Personal-Finance-${bulan.value || "all"}.csv`;
  a.click();

  URL.revokeObjectURL(url);
}


const chartEl=document.getElementById("chart");
render();
</script>

</body>
</html>
