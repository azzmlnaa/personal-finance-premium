<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Personal Finance Premium</title>

<!-- CDN AMAN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2pdf.js"></script>

<style>
* { box-sizing: border-box; }
body { margin:0; padding:16px; font-family:system-ui; background:#f1f5f9; color:#0f172a; }
.container { max-width:1100px; margin:auto; }
.card { background:#fff; border-radius:14px; padding:14px; margin-bottom:14px; box-shadow:0 6px 18px rgba(0,0,0,.08); }
h1 { margin:6px 0; }
h2 { margin-bottom:8px; font-size:18px; }
input, button { padding:10px; border-radius:8px; border:1px solid #cbd5e1; width:100%; }
button { background:#2563eb; color:#fff; border:none; cursor:pointer; }
button.red { background:#dc2626; }
button.gray { background:#334155; }
.grid { display:grid; gap:12px; }
.grid-2 { grid-template-columns:1fr; }
@media(min-width:768px){ .grid-2{ grid-template-columns:1fr 1fr; } }

.progress { background:#e5e7eb; height:12px; border-radius:10px; overflow:hidden; }
.bar { height:100%; transition:.3s; }
.safe{background:#22c55e} .warn{background:#f59e0b} .danger{background:#ef4444}

table{width:100%; border-collapse:collapse; font-size:14px}
th,td{padding:8px; border-bottom:1px solid #e5e7eb}
th{background:#f8fafc; text-align:left}

.blur span.amount{filter:blur(6px)}

.login-container{display:flex; justify-content:center; align-items:center; height:100vh}
.login-card{width:300px; background:#fff; padding:20px; border-radius:10px; box-shadow:0 4px 6px rgba(0,0,0,.1)}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login" class="login-container">
  <div class="login-card">
    <h2>Masukkan PIN</h2>
    <input type="password" id="pin">
    <button onclick="checkPin()">Masuk</button>
    <p id="error" style="color:red; display:none">PIN salah</p>
  </div>
</div>

<!-- APP -->
<div id="app" class="container" style="display:none">
<h1>ğŸ“Š Personal Finance Premium</h1>

<div class="grid grid-2">
  <button class="gray" onclick="toggleBlur()">ğŸ‘ Mode Privat</button>
  <button class="red" onclick="resetData()">ğŸ—‘ Reset Data</button>
</div>

<div class="card">
  <h2>ğŸ“… Bulan</h2>
  <input type="month" id="bulan">
</div>

<div class="card">
  <h2>ğŸ“Œ Ringkasan</h2>
  <p>Pemasukan: Rp <span class="amount" id="sumIn">0</span></p>
  <p>Pengeluaran: Rp <span class="amount" id="sumOut">0</span></p>
  <p><b>Saldo: Rp <span class="amount" id="saldo">0</span></b></p>
</div>

<div class="card">
  <h2>ğŸ¯ Budget per Kategori</h2>
  <div class="grid grid-2">
    <input id="bKat" placeholder="Kategori">
    <input id="bNom" placeholder="Target (Rp)">
  </div>
  <button onclick="saveCategoryBudget()">Simpan Budget</button>
  <div id="budgetList"><i>Belum ada budget</i></div>
</div>

<div class="grid grid-2">
  <div class="card">
    <h2>â• Pemasukan</h2>
    <input type="date" id="inTgl">
    <input id="inSrc" placeholder="Sumber">
    <input id="inNom" placeholder="Nominal">
    <input id="inNote" placeholder="Catatan">
    <button onclick="addIncome()">Simpan</button>
  </div>

  <div class="card">
    <h2>â– Pengeluaran</h2>
    <input type="date" id="outTgl">
    <input id="outKat" placeholder="Kategori">
    <input id="outNom" placeholder="Nominal">
    <input id="outNote" placeholder="Catatan">
    <button onclick="addOut()">Simpan</button>
  </div>
</div>

<div class="card">
  <h2>ğŸ“ˆ Grafik Pengeluaran</h2>
  <canvas id="chart"></canvas>
</div>

<div class="card">
<h2>ğŸ“‘ Riwayat</h2>
<table>
<thead>
<tr><th>Tanggal</th><th>Keterangan</th><th>Nominal</th><th>Catatan</th><th></th></tr>
</thead>
<tbody id="list"></tbody>
</table>
</div>

<button onclick="printPDF()">ğŸ–¨ Cetak PDF</button>
<button onclick="exportExcel()" style="background:#16a34a; margin-top:8px">ğŸ“Š Export Excel</button>
</div>

<script>
/* ====== CORE ====== */
const PIN = "180604"
let blur=false
let chart=null

let db = JSON.parse(localStorage.getItem("pf2")) || { income:[], out:[], budget:{} }

const f=v=>v.replace(/\D/g,'').replace(/\B(?=(\d{3})+(?!\d))/g,'.')
const p=v=>Number(v.replace(/\./g,''))

bNom.oninput=e=>e.target.value=f(e.target.value)
inNom.oninput=e=>e.target.value=f(e.target.value)
outNom.oninput=e=>e.target.value=f(e.target.value)

function checkPin(){
  pin.value===PIN ? (login.style.display="none", app.style.display="block", render())
  : error.style.display="block"
}

function save(){ localStorage.setItem("pf2",JSON.stringify(db)); render() }
function m(){ return bulan.value }
function byMonth(a){ return !m()?a:a.filter(x=>x.t.startsWith(m())) }

function saveCategoryBudget(){
  if(!m()||!bKat.value||!bNom.value) return alert("Lengkapi")
  db.budget[m()] ??= {}
  db.budget[m()][bKat.value]=p(bNom.value)
  bKat.value=bNom.value=""
  save()
}

function addIncome(){
  if(!inTgl.value||!inSrc.value||!inNom.value) return
  db.income.push({id:Date.now(),t:inTgl.value,k:inSrc.value,n:p(inNom.value),note:inNote.value})
  inNom.value=inNote.value=""
  save()
}

function addOut(){
  if(!outTgl.value||!outKat.value||!outNom.value) return
  db.out.push({id:Date.now(),t:outTgl.value,k:outKat.value,n:p(outNom.value),note:outNote.value})
  outNom.value=outNote.value=""
  save()
}

function del(id){
  db.income=db.income.filter(x=>x.id!==id)
  db.out=db.out.filter(x=>x.id!==id)
  save()
}

function resetData(){
  if(confirm("Hapus semua data?")){
    localStorage.removeItem("pf2")
    location.reload()
  }
}

function toggleBlur(){
  blur=!blur
  app.classList.toggle("blur",blur)
}

function render(){
  const inc=byMonth(db.income)
  const out=byMonth(db.out)
  const ti=inc.reduce((a,b)=>a+b.n,0)
  const to=out.reduce((a,b)=>a+b.n,0)

  sumIn.innerText=ti.toLocaleString("id-ID")
  sumOut.innerText=to.toLocaleString("id-ID")
  saldo.innerText=(ti-to).toLocaleString("id-ID")

  renderBudget(out)
  renderChart(out)
  renderTable(inc,out)
}

function renderBudget(out){
  let b=db.budget[m()]||{}
  let html=""
  for(let k in b){
    let used=out.filter(x=>x.k===k).reduce((a,b)=>a+b.n,0)
    let pct=Math.min(used/b[k]*100,100)
    let cls=pct<80?"safe":pct<100?"warn":"danger"
    html+=`<div>${k} â€” Rp ${used.toLocaleString()}</div>
    <div class="progress"><div class="bar ${cls}" style="width:${pct}%"></div></div>`
  }
  budgetList.innerHTML=html||"<i>Belum ada budget</i>"
}

function renderChart(out){
  let map={}
  out.forEach(x=>map[x.k]=(map[x.k]||0)+x.n)
  if(chart) chart.destroy()
  chart=new Chart(document.getElementById("chart"),{
    type:"pie",
    data:{labels:Object.keys(map),datasets:[{data:Object.values(map)}]}
  })
}

function renderTable(inc,out){
  let r=[]
  inc.forEach(x=>r.push({...x,n:x.n}))
  out.forEach(x=>r.push({...x,n:-x.n}))
  r.sort((a,b)=>a.t.localeCompare(b.t))
  list.innerHTML=r.map(x=>`
  <tr>
    <td>${x.t}</td>
    <td>${x.k}</td>
    <td style="color:${x.n<0?'red':'green'}">Rp <span class="amount">${Math.abs(x.n).toLocaleString()}</span></td>
    <td>${x.note||'-'}</td>
    <td><button class="red" onclick="del(${x.id})">ğŸ—‘</button></td>
  </tr>`).join("")
}

function printPDF(){
  html2pdf(app,{filename:"Personal-Finance.pdf",html2canvas:{scale:2}})
}

function exportExcel(){
  let rows=[["Tanggal","Jenis","Kategori","Nominal"]]
  byMonth(db.income).forEach(x=>rows.push([x.t,"Pemasukan",x.k,x.n]))
  byMonth(db.out).forEach(x=>rows.push([x.t,"Pengeluaran",x.k,-x.n]))
  let csv=rows.map(r=>r.join(",")).join("\n")
  let a=document.createElement("a")
  a.href=URL.createObjectURL(new Blob([csv]))
  a.download="Personal-Finance.csv"
  a.click()
}
</script>

</body>
</html>
